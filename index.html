<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redirecting to Auth0â€¦</title>
  <script type="module">
    import { createAuth0Client } from '/vendor/auth0-spa-js.production.esm.js';

    const DOMAIN = "dev-ppsnetwf.us.auth0.com";
    const CLIENT_ID = "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj";
    const REDIRECT_URI = window.location.origin + "/";

    async function go() {
      const auth0 = await createAuth0Client({
        domain: DOMAIN,
        clientId: CLIENT_ID,
        authorizationParams: { redirect_uri: REDIRECT_URI, scope: "openid profile email" }
      });

      const qs = new URLSearchParams(window.location.search);

      // Handle callback (after Auth0 redirects back)
      if (qs.has("code") || qs.has("error")) {
        try { await auth0.handleRedirectCallback(); }
        finally { history.replaceState({}, document.title, window.location.pathname); }
      }

      const authed = await auth0.isAuthenticated();
      if (!authed) {
        // ðŸš€ Immediately send to Auth0 login
        await auth0.loginWithRedirect();
      } else {
        // Already logged in â†’ show user profile
        const user = await auth0.getUser();
        document.body.innerHTML = `
          <h1>Welcome, ${user.name}</h1>
          <pre>${JSON.stringify(user, null, 2)}</pre>
        `;
        
        <script>
async function showAuthed(user) {
  userNameEl.textContent = user?.name || user?.email || 'User';
  userEmailEl.textContent = user?.email || '';
  loginSection.style.display = 'none';
  authenticatedSection.style.display = 'block';
  startClock();

  // ðŸ”¹ CHIAMATA ALLA FUNZIONE mgmt-user
  try {
    const res = await fetch('/.netlify/functions/mgmt-user');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    console.log("Mgmt-user data:", data);

    // se vuoi mostrare qualcosa in pagina
    const mgmtEl = document.createElement('pre');
    mgmtEl.textContent = JSON.stringify(data, null, 2);
    authenticatedSection.appendChild(mgmtEl);
  } catch (err) {
    console.error("Errore chiamando mgmt-user:", err);
  }
}
</script>
        
        
      }
    }

    go();
  </script>
</head>
<body>
  <p>Redirecting you to loginâ€¦</p>
</body>
</html>

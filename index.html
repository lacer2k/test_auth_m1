<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Auth0 Popup â€” Minimal Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 2rem; }
    button { padding: 8px 14px; border: 0; border-radius: 999px; background:#000; color:#fff; cursor:pointer; }
    #row { display:flex; gap:24px; flex-wrap:wrap; margin-top: 1rem; }
    pre { background:#f6f8fa; padding:1rem; border-radius:8px; max-width:900px; white-space:pre-wrap; }
    .card { flex:1 1 420px; min-width: 320px; }
  </style>
</head>
<body>
  <h1>Auth0 Login (Popup) + M2M (Server)</h1>
  <p>No callback page. Click login, complete Auth0 Universal Login in a popup, and see results here.</p>
  <div>
    <button id="login">Login</button>
    <button id="logout" style="display:none;background:#555;">Logout</button>
  </div>

  <div id="row">
    <div class="card">
      <h3>Auth0 (Client) â€” <code>getUser()</code></h3>
      <pre id="userBox">â€“ not loaded â€“</pre>
    </div>
    <div class="card">
      <h3>Auth0 (Server via M2M) â€” Management API</h3>
      <pre id="mgmtBox">â€“ not loaded â€“</pre>
    </div>
  </div>

  <script type="module">
    import createAuth0Client from "https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.1.3/dist/auth0-spa-js.production.esm.js";

    const userBox = document.getElementById('userBox');
    const mgmtBox = document.getElementById('mgmtBox');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');

    // ðŸ”§ Your Auth0 SPA app (safe to expose Client ID in frontend; NOT secrets)
    const auth0 = await createAuth0Client({
      domain: "dev-ppsnetwf.us.auth0.com",
      clientId: "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj",
      // No redirect_uri needed for popup
      cacheLocation: "localstorage",
      useRefreshTokens: true
    });

    async function render() {
      const isAuth = await auth0.isAuthenticated();
      loginBtn.style.display = isAuth ? "none" : "inline-block";
      logoutBtn.style.display = isAuth ? "inline-block" : "none";

      if (!isAuth) {
        userBox.textContent = "â€“ not logged in â€“";
        mgmtBox.textContent = "â€“ not logged in â€“";
        return;
      }

      const user = await auth0.getUser();
      userBox.textContent = JSON.stringify(user, null, 2);

      // Ask server (Netlify Function) to fetch Management API profile for this sub
      try {
        const res = await fetch("/.netlify/functions/mgmt-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sub: user.sub })
        });
        const data = await res.json();
        mgmtBox.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        mgmtBox.textContent = "ERROR calling mgmt-user: " + (e?.message || e);
      }
    }

    loginBtn.onclick = async () => {
      try {
        await auth0.loginWithPopup(); // ðŸ‘ˆ No redirects, no callback page
      } catch (e) {
        alert("Login failed: " + (e?.error_description || e?.message || e));
      }
      render();
    };

    logoutBtn.onclick = async () => {
      // Log out locally (and optionally federated)
      await auth0.logout({ logoutParams: { returnTo: window.location.origin } });
      render();
    };

    // Auto-render on load (refresh will keep session if allowed in Auth0)
    render();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Auth0 + Netlify</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self' https://dev-ppsnetwf.us.auth0.com;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;
                 frame-src https://*.auth0.com;">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; line-height: 1.45; }
    button { padding:.6rem 1rem; border-radius:8px; border:0; cursor:pointer; }
    .primary { background:#4f46e5; color:#fff; }
    .danger { background:#ef4444; color:#fff; }
    pre { background:#0b1020; color:#c9f7ff; padding:12px; border-radius:8px; overflow:auto; }
    .muted { opacity:.7; }
  </style>

  <script type="module">
    const DOMAIN = "dev-ppsnetwf.us.auth0.com";
    const CLIENT_ID = "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj";
    const REDIRECT_URI = window.location.origin + "/callback";
    const LOGIN_FLAG = "auth0_login_in_progress";

    // Load SDK from /vendor (your build puts it there)
    const { createAuth0Client } = await import('/vendor/auth0-spa-js.production.esm.js');
    const auth0 = await createAuth0Client({
      domain: DOMAIN,
      clientId: CLIENT_ID,
      authorizationParams: { redirect_uri: REDIRECT_URI, scope: "openid profile email" }
    });

    // ----- UI helpers -----
    const root = document.body;
    function renderLoggedOut(msg) {
      root.innerHTML = `
        <h1>Welcome</h1>
        ${msg ? `<p class="muted">${msg}</p>` : ""}
        <button id="login" class="primary">Login with Auth0</button>
        <pre id="log">Not authenticated.</pre>
      `;
      document.getElementById('login').onclick = async () => {
        if (!sessionStorage.getItem(LOGIN_FLAG)) {
          sessionStorage.setItem(LOGIN_FLAG, "1");  // prevent double attempts
          await auth0.loginWithRedirect();          // navigates away
        }
      };
    }

    function renderLoggedIn(claims, mgmt) {
      root.innerHTML = `
        <h1>Welcome, ${claims.name || claims.email}</h1>
        <p class="muted">You are authenticated. Management API result below.</p>
        <div style="display:flex; gap:8px; margin:.5rem 0 1rem;">
          <button id="logout" class="danger">Logout</button>
          <button id="refresh" class="">Reload mgmt-user</button>
        </div>
        <h3>ID Token claims</h3>
        <pre id="claims">${JSON.stringify(claims, null, 2)}</pre>
        <h3>Management API profile</h3>
        <pre id="out">${mgmt ? JSON.stringify(mgmt, null, 2) : "Loading…"}</pre>
      `;
      document.getElementById('logout').onclick = () => {
        sessionStorage.removeItem(LOGIN_FLAG);
        auth0.logout({ logoutParams: { returnTo: window.location.origin } });
      };
      document.getElementById('refresh').onclick = () => loadMgmt(claims);
    }

    async function loadMgmt(claims) {
      const idToken = (await auth0.getIdTokenClaims()).__raw;
      const res = await fetch('/.netlify/functions/mgmt-user?user_id=' + encodeURIComponent(claims.sub), {
        headers: { Authorization: 'Bearer ' + idToken }
      });
      const text = await res.text();
      const out = document.getElementById('out');
      try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
      catch { out.textContent = text; }
    }

    // ----- Router-ish: handle /callback once, then go home -----
    const url = new URL(window.location.href);
    const isCallback = url.pathname === "/callback";
    const hasAuthParams = url.searchParams.has("code") || url.searchParams.has("state") || url.searchParams.has("error");

    if (isCallback && hasAuthParams) {
      try {
        await auth0.handleRedirectCallback();       // finish OAuth
      } catch (e) {
        // If state mismatch or similar, reset flag and show login button
        sessionStorage.removeItem(LOGIN_FLAG);
        return renderLoggedOut("Callback error: " + (e?.message || e));
      }
      // success → clear the “in progress” flag and go to the app (not /callback)
      sessionStorage.removeItem(LOGIN_FLAG);
      const appReturn = url.searchParams.get("app_return") || (window.location.origin + "/");
      window.location.replace(appReturn);
      // stop here; next load will run the normal branch
    } else {
      // Normal page load
      let authed = false;
      try {
        authed = await auth0.isAuthenticated();
      } catch (e) {
        return renderLoggedOut("Auth check failed: " + (e?.message || e));
      }

      if (!authed) {
        // DO NOT auto-redirect → avoid loops. Let user click.
        return renderLoggedOut();
      }

      // Authenticated → get claims & call mgmt-user
      const c = await auth0.getIdTokenClaims();
      const claims = {
        given_name: c.given_name, family_name: c.family_name, nickname: c.nickname,
        name: c.name, picture: c.picture, updated_at: c.updated_at,
        email: c.email, email_verified: c.email_verified, sub: c.sub, __raw: c.__raw
      };
      renderLoggedIn(claims);
      loadMgmt(claims).catch(err => {
        const out = document.getElementById('out');
        out.textContent = "Mgmt error: " + (err?.message || err);
      });
    }
  </script>
</head>
<body>
  Loading…
</body>
</html>
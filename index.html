<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Auth0 Popup + M2M</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 2rem; }
    button { padding: 8px 14px; border: 0; border-radius: 999px; background:#000; color:#fff; cursor:pointer; }
    button.ghost { background:#666; }
    .grid { display:flex; gap:24px; flex-wrap:wrap; margin-top: 16px; }
    .card { flex:1 1 420px; min-width:320px; }
    pre { background:#f6f8fa; padding:1rem; border-radius:8px; white-space:pre-wrap; }
    img.avatar { width:64px; height:64px; border-radius:50%; vertical-align:middle; margin-right:10px; }
  </style>
</head>
<body>
  <h1>Auth0 Login (Popup) + Management API</h1>
  <p>Login via popup (niente callback). Mostro il profilo dell’ID Token <em>e</em> quello della Management API (M2M).</p>

  <div>
    <button id="login">Login</button>
    <button id="logout" class="ghost" style="display:none;">Logout</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Client (ID Token) — <code>getUser()</code></h3>
      <div id="clientHeader"></div>
      <pre id="clientBox">– non autenticato –</pre>
    </div>
    <div class="card">
      <h3>Server (M2M) — Management API</h3>
      <div id="mgmtHeader"></div>
      <pre id="mgmtBox">– non autenticato –</pre>
    </div>
  </div>

  <script type="module">
    // Usa la DEFAULT import (non quella nominata) dal tuo vendor locale
    import createAuth0Client from "/vendor/auth0-spa-js.production.esm.js";

    const DOMAIN = "dev-ppsnetwf.us.auth0.com";
    const CLIENT_ID = "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj";

    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const clientBox = document.getElementById("clientBox");
    const mgmtBox = document.getElementById("mgmtBox");
    const clientHeader = document.getElementById("clientHeader");
    const mgmtHeader = document.getElementById("mgmtHeader");

    // Inizializza Auth0 SPA client (popup flow, nessun redirect/callback)
    const auth0 = await createAuth0Client({
      domain: DOMAIN,
      clientId: CLIENT_ID,
      cacheLocation: "localstorage",
      useRefreshTokens: true,
      authorizationParams: { scope: "openid profile email" }
    });

    async function render() {
      const isAuth = await auth0.isAuthenticated();
      loginBtn.style.display = isAuth ? "none" : "inline-block";
      logoutBtn.style.display = isAuth ? "inline-block" : "none";

      if (!isAuth) {
        clientHeader.innerHTML = "";
        mgmtHeader.innerHTML = "";
        clientBox.textContent = "– non autenticato –";
        mgmtBox.textContent = "– non autenticato –";
        return;
      }

      // 1) Profilo lato client (ID Token)
      const user = await auth0.getUser(); // contiene name, email, picture, ecc.
      const picture = user.picture ? `<img class="avatar" src="${user.picture}" alt="avatar">` : "";
      clientHeader.innerHTML = `${picture}<strong>${user.name || user.nickname || user.email || "Utente"}</strong>`;
      clientBox.textContent = JSON.stringify(user, null, 2);

      // 2) Profilo lato server (Management API via M2M) — passiamo il sub in query
      mgmtHeader.innerHTML = "Recupero profilo Management API…";
      mgmtBox.textContent = "";
      try {
        const res = await fetch(`/.netlify/functions/mgmt-user?sub=${encodeURIComponent(user.sub)}`);
        const data = await res.json();

        if (!res.ok) {
          mgmtHeader.innerHTML = `<strong>Errore Management API</strong>`;
          mgmtBox.textContent = JSON.stringify(data, null, 2);
          return;
        }

        const headerName = data.name || data.nickname || data.email || data.user_id || "Utente";
        const headerPic = data.picture ? `<img class="avatar" src="${data.picture}" alt="avatar">` : "";
        mgmtHeader.innerHTML = `${headerPic}<strong>${headerName}</strong>`;

        // Mostra “il resto”: email, verified, logins_count, last_login, identities…
        mgmtBox.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        mgmtHeader.innerHTML = `<strong>Errore chiamando mgmt-user</strong>`;
        mgmtBox.textContent = (e?.message || String(e));
      }
    }

    loginBtn.onclick = async () => {
      try {
        await auth0.loginWithPopup(); // niente redirect, niente callback
      } catch (e) {
        alert("Login fallito: " + (e?.error_description || e?.message || e));
      }
      render();
    };

    logoutBtn.onclick = async () => {
      await auth0.logout({ logoutParams: { returnTo: window.location.origin } });
      render();
    };

    // Render iniziale (se sessione valida, resta loggato)
    render();
  </script>
</body>
</html>
<script type="module">
  import { createAuth0Client } from '/vendor/auth0-spa-js.production.esm.js';

  const DOMAIN = "dev-ppsnetwf.us.auth0.com";
  const CLIENT_ID = "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj";
  const REDIRECT_URI = window.location.origin + "/";

  async function go() {
    const auth0 = await createAuth0Client({
      domain: DOMAIN,
      clientId: CLIENT_ID,
      authorizationParams: { redirect_uri: REDIRECT_URI, scope: "openid profile email" }
    });

    if (window.location.search.includes("code=")) {
      await auth0.handleRedirectCallback();
      history.replaceState({}, document.title, "/");
    }

    const isAuthed = await auth0.isAuthenticated();
    if (!isAuthed) {
      return auth0.loginWithRedirect();
    }

    // ðŸ‘‡ qui dopo login
    const user = await auth0.getUser();
    console.log("ID Token user:", user);

    // ðŸ‘‡ chiamata al tuo endpoint serverless
    // ðŸ‘‡ call your serverless function WITH the user's sub
const res = await fetch("/.netlify/functions/mgmt-user", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ sub: user.sub })
});
const data = await res.json();
    console.log("Management API user:", data);

    document.body.innerHTML = `
      <h1>Benvenuto ${data.user?.name || user.name}</h1>
      <pre>${JSON.stringify(data, null, 2)}</pre>
    `;
  }

  go();
</script>
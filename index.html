<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Auth0 Login + Management API (Netlify)</title>

  <!-- Content Security Policy: allow our domain + Auth0 CDNs -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://cdn.auth0.com https://unpkg.com 'unsafe-inline';
                 connect-src 'self' https://dev-ppsnetwf.us.auth0.com https://*.auth0.com https://*.netlify.app;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https:;
                 frame-src https://*.auth0.com;">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    button { padding: .6rem 1rem; margin-right: .5rem; }
    pre { background: #0b1020; color: #c9f7ff; padding: 12px; border-radius: 8px; max-width: 1000px; overflow:auto; }
    .muted { opacity:.7; }
  </style>

  <!-- Load Auth0 SDK FIRST (no defer/async). Add fallback if it fails -->
  <script>
    function loadAuth0Fallback(){
      console.warn('[Auth0] Primary SDK failed, loading fallback from unpkg…');
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/@auth0/auth0-spa-js@2.1.3/dist/auth0-spa-js.production.js';
      s.onload = () => console.log('[Auth0] Fallback SDK loaded');
      s.onerror = () => console.error('[Auth0] Fallback SDK failed to load');
      document.head.appendChild(s);
    }
  </script>
  <script id="auth0-sdk"
          src="https://cdn.auth0.com/js/auth0-spa-js/2.0.7/auth0-spa-js.production.js"
          onload="console.log('[Auth0] SDK loaded')"
          onerror="loadAuth0Fallback()"></script>
</head>
<body>
  <h1>Auth0 Login</h1>
  <p class="muted">SPA → Netlify Function → Auth0 Management API</p>

  <p><strong>Status:</strong> <span id="status">Booting…</span></p>
  <p>
    <button id="login">Login</button>
    <button id="logout" disabled>Logout</button>
    <button id="me" disabled>Get profile (via Management API)</button>
    <button id="selftest">Run server self-test</button>
  </p>
  <pre id="out">Ready.</pre>

  <script>
    // === Config SPA (public SPA Client ID) ===
    const DOMAIN = "dev-ppsnetwf.us.auth0.com";
    const CLIENT_ID = "v8SikCjLbbH0ioHuoKSkADBHcofOOWHj";
    const REDIRECT_URI = window.location.origin + "/";

    const $ = (id) => document.getElementById(id);
    const log = (x) => { $("out").textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2); };
    const setStatus = (s) => $("status").textContent = s;

    let auth0Client = null;

    async function safeInit() {
      // Verify SDK presence
      if (typeof createAuth0Client !== "function") {
        console.error("[Auth0] SDK not available (createAuth0Client undefined).");
        setStatus("SDK not loaded");
        log("Auth0 SDK non caricato: controlla rete, CSP o estensioni/AdBlock. Vedi Network tab per il file auth0-spa-js.production.js.");
        return;
      }

      try {
        auth0Client = await createAuth0Client({
          domain: DOMAIN,
          clientId: CLIENT_ID,
          authorizationParams: { redirect_uri: REDIRECT_URI, scope: "openid profile email" }
        });

        const qs = new URLSearchParams(window.location.search);
        if (qs.has("code") || qs.has("error")) {
          try { await auth0Client.handleRedirectCallback(); }
          finally { history.replaceState({}, document.title, window.location.pathname); }
        }

        const authed = await auth0Client.isAuthenticated();
        $("logout").disabled = !authed;
        $("me").disabled = !authed;

        if (authed) {
          const user = await auth0Client.getUser();
          setStatus("Logged in");
          log({ status: "logged-in", user });
        } else {
          setStatus("Not authenticated");
          log("Click Login to authenticate.");
        }
      } catch (e) {
        console.error("[Auth0] init error:", e);
        setStatus("Init failed");
        log(e);
      }
    }

    $("login").onclick  = () => auth0Client.loginWithRedirect();
    $("logout").onclick = () => auth0Client.logout({ logoutParams: { returnTo: window.location.origin } });
    $("me").onclick     = async () => {
      try {
        const claims = await auth0Client.getIdTokenClaims();
        const sub = claims?.sub;
        if (!sub) return log("No sub in ID token; fai login prima.");
        setStatus("Fetching profile via function…");
        const res = await fetch("/.netlify/functions/mgmt-user?user_id=" + encodeURIComponent(sub));
        const text = await res.text();
        try { log(JSON.parse(text)); } catch { log(text); }
        setStatus("Done");
      } catch (e) { log(e); setStatus("Error"); }
    };

    $("selftest").onclick = async () => {
      setStatus("Running self-test…");
      const res = await fetch("/.netlify/functions/mgmt-selftest");
      const txt = await res.text();
      try { log(JSON.parse(txt)); } catch { log(txt); }
      setStatus("Self-test done");
    };

    // Wait a tick so the SDK <script> can execute, then init
    document.addEventListener("DOMContentLoaded", () => {
      // small delay to ensure onload executed if needed
      setTimeout(safeInit, 0);
    });
  </script>
</body>
</html>